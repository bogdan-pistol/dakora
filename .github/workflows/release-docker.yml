name: Release Docker Images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 2.0.0)'
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version tag (e.g., 2.0.0)'
        required: true
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    strategy:
      matrix:
        component: [server, studio]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/${{ matrix.component }}
        tags: |
          type=raw,value=${{ inputs.version }}
          type=raw,value=latest

    - name: Build and push ${{ matrix.component }}
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.component }}
        file: ./${{ matrix.component }}/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Create git tag for Docker release
      if: matrix.component == 'server'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "docker-v${{ inputs.version }}" -m "Docker Release v${{ inputs.version }}"
        git push origin "docker-v${{ inputs.version }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: "docker-v${{ inputs.version }}"
        name: "Docker Images v${{ inputs.version }}"
        body: |
          ## Dakora Docker Images v${{ inputs.version }}

          ### Images
          - `ghcr.io/${{ github.repository }}/server:${{ inputs.version }}`
          - `ghcr.io/${{ github.repository }}/studio:${{ inputs.version }}`

          ### Usage
          ```bash
          # Pull images
          docker pull ghcr.io/${{ github.repository }}/server:${{ inputs.version }}
          docker pull ghcr.io/${{ github.repository }}/studio:${{ inputs.version }}

          # Or use docker-compose.yml
          dakora start
          ```

          ### Self-hosting
          See docs/self-hosting.md for full instructions.
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}